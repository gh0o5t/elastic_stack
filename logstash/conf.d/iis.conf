input {
	file {
		type => "iis"
		path => "/usr/share/logstash/Logs/*.log"
		start_position => "beginning"
	}
}

filter {

	# ignore log comments
	if [message] =~ "^#" {
		drop {}
	}
 
 	# check that fields match your IIS log settings
   #Fields: date time s-ip cs-method cs-uri-stem cs-uri-query s-port cs-username c-ip cs(User-Agent) cs(Referer) sc-status sc-substatus sc-win32-status time-taken Source-IP Net-IP 
   #2020-12-01 23:59:47 10.172.24.41 POST /mapi/emsmdb/ MailboxId=87008e5b-2df5-4127-ae65-ef6c92881328@xy.hu&CorrelationID=<empty>;&cafeReqId=2f16b6e6-2519-4256-93c8-2259a646287c; 443 - 172.27.32.101 Microsoft+Office/16.0+(Windows+NT+10.0;+Microsoft+Outlook+16.0.4954;+Pro) - 401 2 5 1 10.213.56.17 -
	grok {
        match => ["message", "%{TIMESTAMP_ISO8601:log_timestamp} %{IPORHOST:site} %{WORD:method} %{URIPATH:page} %{NOTSPACE:querystring} %{NUMBER:port} %{NOTSPACE:username} %{IPORHOST:clienthost} %{NOTSPACE:useragent} %{NOTSPACE:referer} %{NUMBER:response} %{NUMBER:subresponse} %{NUMBER:scstatus} %{NUMBER:time_taken:int} %{NOTSPACE:sourceip} %{NOTSPACE:netip}"]
	}
  
	# set the event timestamp from the log
	# https://www.elastic.co/guide/en/logstash/current/plugins-filters-date.html
	date {
		match => [ "log_timestamp", "YYYY-MM-dd HH:mm:ss" ]
		timezone => "Europe/Budapest"
	}
	
	# matches the big, long nasty useragent string to the actual browser name, version, etc
	# https://www.elastic.co/guide/en/logstash/current/plugins-filters-useragent.html
	useragent {
		source=> "useragent"
		prefix=> "browser_"
	}
	
	#mutate {
		#remove_field => [ "log_timestamp"]
	#}
}

# output logs to console and to elasticsearch
output {
    stdout { codec => rubydebug }
	elasticsearch { 
        hosts => ["http://es01:9200"]
        index => "iis_xy"
    }
}
